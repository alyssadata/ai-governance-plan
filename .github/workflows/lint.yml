name: Repo checks (YAML + CSV)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Validate YAML files
        run: |
          python - <<'PY'
          from pathlib import Path
          import sys
          import yaml

          yaml_paths = sorted(set(list(Path(".").rglob("*.yml")) + list(Path(".").rglob("*.yaml"))))
          if not yaml_paths:
            print("No YAML files found.")
            sys.exit(0)

          errors = 0
          for p in yaml_paths:
            try:
              text = p.read_text(encoding="utf-8")
              yaml.safe_load(text)
              print(f"OK  {p}")
            except Exception as e:
              errors += 1
              msg = str(e).replace("\n", " ")
              print(f"FAIL {p}: {msg}")
              print(f"::error file={p}::{msg}")

          if errors:
            print(f"YAML validation failed: {errors} file(s).")
            sys.exit(1)

          print(f"YAML OK: {len(yaml_paths)} file(s) validated")
          PY

      - name: Validate CSV column counts in registers (ignore blank lines)
        run: |
          python - <<'PY'
          from pathlib import Path
          import csv
          import sys

          reg_dir = Path("registers")
          if not reg_dir.exists():
            print("No registers/ directory found, skipping CSV validation.")
            sys.exit(0)

          csv_files = sorted(reg_dir.glob("*.csv"))
          if not csv_files:
            print("No CSV files found in registers/, skipping CSV validation.")
            sys.exit(0)

          errors = 0

          for f in csv_files:
            with f.open("r", encoding="utf-8", newline="") as fh:
              reader = csv.reader(fh)
              rows = list(reader)

            if not rows:
              errors += 1
              print(f"FAIL {f}: empty file")
              print(f"::error file={f}::empty file")
              continue

            header = rows[0]
            expected = len(header)
            print(f"CHECK {f} (expected columns: {expected})")

            for i, row in enumerate(rows[1:], start=2):
              # Skip completely blank lines ([], or ["", "", ...])
              if not row or all((c.strip() == "" for c in row)):
                continue

              if len(row) != expected:
                errors += 1
                msg = f"row {i} has {len(row)} columns, expected {expected}"
                print(f"FAIL {f}: {msg}")
                print(f"::error file={f},line={i}::{msg}")

          if errors:
            print(f"CSV validation failed: {errors} issue(s).")
            sys.exit(1)

          print(f"CSV OK: {len(csv_files)} file(s) validated")
          PY

